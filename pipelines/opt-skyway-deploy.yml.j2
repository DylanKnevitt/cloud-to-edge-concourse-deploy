---
# Use reference instead of repeating the skyway params
skyway_params: &skyway-params
  ENABLE_ANSIBLE_DEBUG: ((enable_ansible_debug))
  SKYWAY_INSTALLER: ((skyway_installer))
  NTPSERVERS: ((ntpservers))
  DNSSERVER: ((dnsserver))
  DNSDOMAIN: ((dnsdomain))
  DEFAULTGATEWAY: ((defaultgateway))
  NETMASK: ((netmask))
  binary_webserver: ((binary_webserver))
  base_ova_name: ((base_ova_name))
  base_ova_name_arm: ((base_ova_name_arm))
  base_ova_origin: ((binary_webserver))/((base_ova_name))
  base_ova_origin_arm: ((binary_webserver))/((base_ova_name_arm))
  skyway_edge_vm_basename: ((skyway_edge_vm_basename))
  skyway_edge_vm_user: ((skyway_edge_vm_user))
  skyway_edge_vm_password: ((skyway_edge_vm_password))
  skyway_edge_vm_network: ((skyway_edge_vm_network))
  skyway_edge_vm_ssh_priv_key: ((skyway_edge_vm_ssh_priv_key))
  skyway_edge_vm_ssh_pub_key: ((skyway_edge_vm_ssh_pub_key))
  skyway_edge_deploy_size: ((skyway_edge_deploy_size))
  GIT_KEY: ((git_key))
  azure_iot_enable: ((azure_iot_enable))
  azure_cli_application_id: ((azure_cli_application_id))
  azure_cli_application_key: ((azure_cli_application_key))
  azure_cli_tenant_id: ((azure_cli_tenant_id))
  azure_iot_hub_name: ((azure_iot_hub_name))
  azure_iot_group: ((azure_iot_group))
  azure_iot_edge_names: ((azure_iot_edge_names))
  aws_greengrass_enable: ((aws_greengrass_enable))
  aws_access_key: ((aws_access_key))
  aws_secret_key: ((aws_secret_key))
  aws_region: ((aws_region))
  greengrass_s3_bucket: ((greengrass_s3_bucket))
  skip_s3_uploads: false
  greengrass_group_names: ((greengrass_group_names))
  greengrass_device_stub: ((greengrass_device_stub))
  greengrass_device_count: ((greengrass_device_count))
  greengrass_deploy: ((greengrass_deploy))
  skyway_edges: ((skyway_edges))
  skyway_edge_start: 0
  skyway_edge_end: 0
  skyway_bundle_params: ((skyway_bundle_params))

{% for range in ranges %}
skyway_params_{{ range.min }}_{{ range.max }}: &skyway_params_{{ loop.index }}
  <<: *skyway-params
  skyway_edge_start: {{ range.min }}
  skyway_edge_end: {{ range.max }}
{% endfor %}

groups:

- name: full-deploy
  jobs:
  - deploy
  - cloud-build
  - edge-build
{% for range in ranges %}
  - vm-build-{{ range.min }}-{{ range.max }}
  - edge-cfg-{{ range.min }}-{{ range.max }}
  - edge-activate-{{ range.min }}-{{ range.max }}
{% endfor %}
  - deploy-finish-VERSION-63{{ config_version|default("") }}

- name: cloud-provider
  jobs:
  - cloud-build
  - edge-build

- name: gateways
  jobs:
{% for range in ranges %}
  - vm-build-{{ range.min }}-{{ range.max }}
  - edge-cfg-{{ range.min }}-{{ range.max }}
  - edge-activate-{{ range.min }}-{{ range.max }}
{% endfor %}

- name: complete
  jobs:
  - deploy-finish-VERSION-63{{ config_version|default("") }}

# - name: cleanup
#   jobs:
#   - uninstall-skyway

resource_types:
- name: file-url
  type: docker-image
  source:
    repository: pivotalservices/concourse-curl-resource

resources:
- name: pipeline
  type: git
  source:
    uri: git@gitlab.com:vmworld2018/skyway-concourse-deploy.git
    branch: master
    private_key: ((git_key))

- name: automation
  type: git
  source:
    uri: git@gitlab.com:vmworld2018/skyway-automation
    branch: master
    private_key: ((git_key))

- name: provider2-iot
  type: git
  source:
    uri: git@gitlab.com:vmworld2018/ansible-role-azure-iot
    branch: master
    private_key: ((git_key))

- name: provider2-edge
  type: git
  source:
    uri: git@gitlab.com:vmworld2018/ansible-role-azure-edge
    branch: master
    private_key: ((git_key))

- name: edge-vm
  type: git
  source:
    uri: git@gitlab.com:vmworld2018/ansible-role-skyway-edge-vm
    branch: master
    private_key: ((git_key))

- name: aws-greengrass
  type: git
  source:
    uri: https://github.com/vmware/ansible-aws-greengrass.git
    branch: master

- name: base-ova
  type: file-url
  source:
    #username: username
    #password: password
    url: ((binary_webserver))/((base_ova_name))
    filename: ((base_ova_name))
    skip_ssl_verification: true

# Download from https://my.vmware.com/group/vmware/details?productId=614&downloadGroup=OVFTOOL420#
- name: ovftool
  type: file-url
  source:
    #username: username
    #password: password
    url: ((binary_webserver))/((ovftool_image))
    filename: ((ovftool_image))
    skip_ssl_verification: true

jobs:

- name: deploy
  plan:
  - aggregate:
    - get: pipeline
    - get: automation
    - get: base-ova
    - get: ovftool
    - get: aws-greengrass

  - task: install-skyway
    file: pipeline/tasks/install-skyway/task.yml
    params: *skyway-params

- name: cloud-build
  plan:
  - aggregate:
    - get: pipeline
    - get: automation
      params: {globs: []}
      passed: [deploy]
      trigger: true
    - get: provider2-iot
    - get: provider2-edge
    - get: aws-greengrass

  - task: initialize-cloud-iot
    file: pipeline/tasks/initialize-cloud-iot/task.yml
    params: *skyway-params

- name: edge-build
  plan:
  - aggregate:
    - get: pipeline
    - get: automation
      params: {globs: []}
      passed: [cloud-build]
      trigger: true
    - get: provider2-iot
    - get: provider2-edge
    - get: aws-greengrass

  - task: deploy-edge-version
    file: pipeline/tasks/deploy-edge-version/task.yml
    params: *skyway-params

{% for range in ranges %}
- name: vm-build-{{ range.min }}-{{ range.max }}
  plan:
  - aggregate:
    - get: pipeline
    - get: automation
      params: {globs: []}
      passed: [edge-build]
      trigger: true
    - get: edge-vm

  - task: vm-build
    file: pipeline/tasks/launch-edge-gateway-vm/task.yml
    params: *skyway_params_{{ loop.index }}

- name: edge-cfg-{{ range.min }}-{{ range.max }}
  plan:
  - aggregate:
    - get: pipeline
    - get: automation
      params: {globs: []}
      passed: [vm-build-{{ range.min }}-{{ range.max }}]
      trigger: true
    - get: provider2-iot
    - get: provider2-edge
    - get: aws-greengrass
    - get: edge-vm

  - task: add-skyway-edge-gateway
    file: pipeline/tasks/add-skyway-edge-gateway/task.yml
    params: *skyway_params_{{ loop.index }}

- name: edge-activate-{{ range.min }}-{{ range.max }}
  plan:
  - aggregate:
    - get: pipeline
    - get: automation
      params: {globs: []}
      passed: [edge-cfg-{{ range.min }}-{{ range.max }}]
      trigger: true
    - get: provider2-iot
    - get: provider2-edge
    - get: aws-greengrass
    - get: edge-vm

  - task: skyway-edge-gateway-configure
    file: pipeline/tasks/edge-gateway-configure/task.yml
    params: *skyway_params_{{ loop.index }}
{% endfor %}

- name: deploy-finish-VERSION-63{{ config_version|default("") }}
  plan:
  - aggregate:
    - get: pipeline
    - get: automation
      params: {globs: []}
      passed:
{% for range in ranges %}
        - edge-activate-{{ range.min }}-{{ range.max }}
{% endfor %}
      trigger: true

  - task: deploy-finish-VERSION-63{{ config_version|default("") }}
    file: pipeline/tasks/noop/task.yml
    params: *skyway-params
